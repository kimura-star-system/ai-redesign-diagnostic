/**
 * Dify APIé€£æºã‚µãƒ¼ãƒ“ã‚¹
 * è¨ºæ–­çµæœã‚’Difyã«é€ä¿¡ã—ã¦AIåˆ†æã‚’å–å¾—
 * Vercel API RouteçµŒç”±ã§é€šä¿¡ï¼ˆCORSå›é¿ + ã‚»ã‚­ãƒ¥ãƒªãƒ†ã‚£å‘ä¸Šï¼‰
 */

import axios from 'axios';
import type { Scores } from '../utils/scoreCalculator';
import { getBottleneckAxis, getLowestQuestions, getAxisLabels } from '../utils/scoreCalculator';

// ğŸ”„ ãƒ¢ãƒ¼ãƒ‰åˆ‡ã‚Šæ›¿ãˆï¼štrue=ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ / false=æœ¬ç•ªAPI (VercelçµŒç”±)
const USE_MOCK_DATA = false;

// API ã‚¨ãƒ³ãƒ‰ãƒã‚¤ãƒ³ãƒˆï¼ˆæœ¬ç•ª: /api/analyzeã€é–‹ç™º: http://localhost:5173/api/analyzeï¼‰
const API_ENDPOINT = '/api/analyze';

interface AnalysisResult {
  success: boolean;
  analysis?: string;
  error?: string;
  fallback?: string;
  raw?: unknown;
}

/**
 * è¨ºæ–­çµæœã‚’Difyã«é€ä¿¡ã—ã¦AIåˆ†æã‚’å–å¾—
 * @param scores - 4è»¸ã®ã‚¹ã‚³ã‚¢
 * @param answers - å…¨20å•ã®å›ç­”
 * @param freeText - ãƒ¦ãƒ¼ã‚¶ãƒ¼ã‹ã‚‰ã®ãƒ•ãƒªãƒ¼ãƒ†ã‚­ã‚¹ãƒˆå…¥åŠ›ï¼ˆä»»æ„ï¼‰
 * @returns Difyã‹ã‚‰ã®åˆ†æçµæœ
 */
export async function analyzeDiagnostic(
  scores: Scores,
  answers: Record<string, number>,
  freeText: string = ''
): Promise<AnalysisResult> {

  // ãƒœãƒˆãƒ«ãƒãƒƒã‚¯è»¸ã‚’è¨ˆç®—
  const bottleneckAxis = getBottleneckAxis(scores);

  // ä½ã‚¹ã‚³ã‚¢è³ªå•ã‚’æŠ½å‡º
  const lowestQuestions = getLowestQuestions(answers);

  // ğŸ”„ ãƒ€ãƒŸãƒ¼ãƒ‡ãƒ¼ã‚¿ãƒ¢ãƒ¼ãƒ‰
  if (USE_MOCK_DATA) {
    return getMockAnalysis(bottleneckAxis, lowestQuestions);
  }

  // ğŸ”’ æœ¬ç•ªAPIãƒ¢ãƒ¼ãƒ‰ï¼ˆVercel API RouteçµŒç”±ï¼‰
  try {
    const payload = {
      scores: {
        human_internal: scores.human_internal,
        resource_internal: scores.resource_internal,
        human_external: scores.human_external,
        environment_external: scores.environment_external
      },
      bottleneckAxis,
      lowestQuestions,
      free_text: freeText
    };

    const response = await axios.post(API_ENDPOINT, payload, {
      headers: {
        'Content-Type': 'application/json'
      }
    });

    console.log('=== API Response ===');
    console.log('response.data:', response.data);

    // API Routeã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹å‡¦ç†
    if (!response.data.success) {
      const errorMsg = response.data.error || response.data.message || 'API request failed';
      console.error('API Error:', errorMsg);
      return {
        success: false,
        error: errorMsg,
        fallback: `âš ï¸ **APIã‚¨ãƒ©ãƒ¼**\n\n${errorMsg}\n\nä¸€æ™‚çš„ã«AIåˆ†æã‚’åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚ã—ã°ã‚‰ãå¾…ã£ã¦ã‹ã‚‰å†åº¦ãŠè©¦ã—ãã ã•ã„ã€‚`
      };
    }

    // ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã®ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ï¼ˆæ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ç­‰ã®é™¤å»ï¼‰
    const cleanAnalysis = cleanDifyResponse(response.data.analysis);

    return {
      success: true,
      analysis: cleanAnalysis,
      raw: response.data.raw
    };

  } catch (error: unknown) {
    console.error('API Error:', error);

    if (axios.isAxiosError(error)) {
      console.error('Response status:', error.response?.status);
      console.error('Response data:', error.response?.data);
      console.error('Request payload:', error.config?.data);
    }

    return {
      success: false,
      error: error instanceof Error ? error.message : 'Unknown error',
      fallback: getDummyAnalysis(scores)
    };
  }
}

/**
 * ãƒ¢ãƒƒã‚¯ãƒ‡ãƒ¼ã‚¿ç”Ÿæˆï¼ˆé–‹ç™ºç”¨ï¼‰
 */
function getMockAnalysis(
  bottleneckAxis: keyof Scores | 'none',
  lowestQuestions: string
): Promise<AnalysisResult> {
  return new Promise((resolve) => {
    setTimeout(() => {
      const axisLabels = getAxisLabels();

      let analysisText = '';

      // æº€ç‚¹ï¼ˆãƒœãƒˆãƒ«ãƒãƒƒã‚¯ãªã—ï¼‰ã®å ´åˆ
      if (bottleneckAxis === 'none') {
        analysisText = `# ğŸ¯ è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ

---

## ğŸš© æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
### **ã€å…¨ã¦ã®å£ã‚’çªç ´ï¼ã€‘**
> ãŠã‚ã§ã¨ã†ã”ã–ã„ã¾ã™ï¼ã‚ãªãŸã¯å…¨ã¦ã®ã€Œå£ã€ã‚’ä¹—ã‚Šè¶Šãˆã€AIã¨é«˜åº¦ã«å”åƒã§ãã‚‹æº–å‚™ãŒæ•´ã£ã¦ã„ã¾ã™ã€‚

---

## ğŸ’¡ å°‚é–€å®¶ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
å…¨ã¦ã®é …ç›®ã§é«˜ã„ã‚¹ã‚³ã‚¢ã‚’é”æˆã•ã‚ŒãŸã“ã¨ã¯é©šãã¹ãæˆæœã§ã™ã€‚ã‚ãªãŸã¯çµ„ç¹”å†…ã§ã®ã€ŒAIå¤‰é©ãƒªãƒ¼ãƒ€ãƒ¼ã€ã¨ã—ã¦ã€è‡ªèº«ã®æˆåŠŸä½“é¨“ã‚’ãƒŠãƒ¬ãƒƒã‚¸åŒ–ã—ã€å‘¨å›²ã‚’å°ã„ã¦ã„ããƒ•ã‚§ãƒ¼ã‚ºã«ã‚ã‚Šã¾ã™ã€‚

ã“ã‚Œã‹ã‚‰ã¯è‡ªåˆ†ã®åŠ¹ç‡åŒ–ã ã‘ã§ãªãã€ãƒãƒ¼ãƒ å…¨ä½“ã€ã‚ã‚‹ã„ã¯çµ„ç¹”å…¨ä½“ã®ã€Œæ¥­å‹™ãƒªãƒ‡ã‚¶ã‚¤ãƒ³ã€ã‚’åŠ é€Ÿã•ã›ã‚‹ãŸã‚ã®ä»•çµ„ã¿åŒ–ã«æŒ‘æˆ¦ã—ã¦ã¿ã¦ãã ã•ã„ã€‚`;
      }
      // ç’°å¢ƒï¼ˆå¤–å´ï¼‰ãŒãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã®å ´åˆï¼ˆãƒ‡ãƒ¢ç”¨ãƒªãƒƒãƒã‚³ãƒ³ãƒ†ãƒ³ãƒ„ï¼‰
      else if (bottleneckAxis === 'environment_external') {
        analysisText = `# ğŸ¯ è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ

---

## ğŸš© æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
### **ã€ç’°å¢ƒã®å£ï¼ˆEnvironment Externalï¼‰ã€‘**
> ã“ã“ãŒã€ã‚ãªãŸã®çµ„ç¹”ãŒã€ŒAIå…±åƒå‹ã€ã¸é€²åŒ–ã™ã‚‹ã®ã‚’å¦¨ã’ã¦ã„ã‚‹æœ€å¤§ã®å£ã§ã™ã€‚

---

## ğŸ” ç¾çŠ¶ã®åˆ†æï¼šãƒªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ™ãƒ«
| ç¾åœ¨ã®æ¨å®šãƒ¬ãƒ™ãƒ« | ç›®æŒ‡ã™ã¹ãå§¿ |
| :--- | :--- |
| **ãƒ¬ãƒ™ãƒ« 2ï¼ˆä¸€éƒ¨è‡ªå‹•åŒ–ï¼‰** | **ãƒ¬ãƒ™ãƒ« 3ï¼ˆæ¥­å‹™å…¨ä½“ã®å†è¨­è¨ˆï¼‰** |

### âš¡ è§£æ±ºã™ã¹ãã€Œ2é‡ã®å£ã€
ç¾åœ¨ã®çµ„ç¹”ã¯ã€ãƒ¬ãƒ™ãƒ«2ï¼ˆéƒ¨åˆ†çš„ãªåŠ¹ç‡åŒ–ï¼‰ã‹ã‚‰ãƒ¬ãƒ™ãƒ«3ã¸ã®å¤‰é©æœŸã«ã‚ã‚Šã¾ã™ãŒã€ãƒªã‚¹ã‚¯ã¸ã®éåº¦ãªæ‡¸å¿µã‹ã‚‰ãƒ–ãƒ¬ãƒ¼ã‚­ãŒã‹ã‹ã£ã¦ã—ã¾ã£ã¦ã„ã¾ã™ã€‚

* **èª²é¡Œ1ï¼šç¤¾ä¼šãƒ»å€«ç†èª²é¡Œã¸ã®ä¸å®‰ [V3]**
  æ³•è¦åˆ¶ã‚„å€«ç†çš„ãƒªã‚¹ã‚¯ã«å¯¾ã™ã‚‹æŒ‡é‡ãŒä¸æ˜ç¢ºãªãŸã‚ã€ç¾å ´ãŒã€Œã©ã“ã¾ã§å®‰å…¨ãªã®ã‹ã€ã‚’åˆ¤æ–­ã§ããšã€èç¸®ã—ã¦ã„ã¾ã™ï¼ˆQ18ã‚¹ã‚³ã‚¢: 1.0ï¼‰ã€‚
* **èª²é¡Œ2ï¼šç›®çš„ç†è§£ã®ä¸è¶³ [H2]**
  ã€Œãªãœä»ŠAIãªã®ã‹ã€ã¨ã„ã†æ ¹æœ¬çš„ãªæ„ç¾©ãŒè…¹è½ã¡ã—ã¦ãŠã‚‰ãšã€ã‚„ã‚‰ã•ã‚Œæ„Ÿã ã‘ãŒå…ˆè¡Œã—ã¦ã„ã¾ã™ï¼ˆQ2ã‚¹ã‚³ã‚¢: 1.0ï¼‰ã€‚

---

## ğŸ› ï¸ æ”¹å–„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ğŸ¾ Step 1ï¼šæœ€åˆã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆå°å…¥ãƒ»çªç ´ï¼‰
* **KBã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼š** å®Œç’§ãªç’°å¢ƒã‚’ç›®æŒ‡ã•ãšã€ã€Œæœ€ä½é™ã“ã‚Œãªã‚‰ä»•äº‹ã¨ã—ã¦å›ã›ã‚‹ã€ã¨ã„ã†æˆåŠŸä½“é¨“ã‚’å°è¦æ¨¡çµ„ç¹”ã§ä½œã‚‹
* **å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š**
  * æ¥é€±ä¸­ã«ã€AIåˆ©ç”¨ã«ãŠã‘ã‚‹ã€Œã“ã‚Œã ã‘ã¯ã‚„ã£ã¦ã¯ã„ã‘ãªã„ï¼ˆNot To Doï¼‰ã€ã‚’ï¼“ã¤ã ã‘æ±ºã‚ãŸæš«å®šã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ä½œæˆã—ã€éƒ¨é•·æ‰¿èªã®ã‚‚ã¨å°‘äººæ•°ãƒãƒ¼ãƒ ã§é©ç”¨ã‚’é–‹å§‹ã™ã‚‹ã€‚
  * ã€ŒãªãœAIã‚’ä½¿ã†ã®ã‹ã€ã‚’èªã‚‹ãƒ©ãƒ³ãƒã‚»ãƒƒã‚·ãƒ§ãƒ³ã‚’é–‹å‚¬ã—ã€å¿ƒç†çš„ãªå®‰å…¨æ€§ã‚’ç¢ºä¿ã™ã‚‹ã€‚
* **æœŸå¾…åŠ¹æœï¼š** 3ãƒ¶æœˆä»¥å†…ã«ã€Œç’°å¢ƒã®å£ã€ã¸ã®ä¸å®‰ãŒæ‰•æ‹­ã•ã‚Œã€ç¾å ´ã‹ã‚‰ã®è‡ªç™ºçš„ãªææ¡ˆãŒå¢—ãˆå§‹ã‚ã¾ã™ã€‚

### ğŸš€ Step 2ï¼šå±•é–‹ã®ãŸã‚ã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼ˆå®šç€ãƒ»ä»•çµ„ã¿åŒ–ï¼‰
* **KBã®ã‚¢ãƒ—ãƒ­ãƒ¼ãƒï¼š** å°è¦æ¨¡çµ„ç¹”ã§æˆåŠŸã—ãŸã‚„ã‚Šæ–¹ã‚’ä¸€èˆ¬åŒ–ã—ã€èª°ãŒã‚„ã£ã¦ã‚‚åŒã˜ã‚ˆã†ã«é‹ç”¨ã§ãã‚‹å½¢ã«ãƒ«ãƒ¼ãƒ«ã‚’æ˜æ–‡åŒ–ãƒ»ä»•çµ„ã¿åŒ–ã™ã‚‹
* **å…·ä½“çš„ãªã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼š**
  * æš«å®šé‹ç”¨ã§å¾—ã‚‰ã‚ŒãŸçŸ¥è¦‹ã‚’å…ƒã«ã€å…¨ç¤¾å‘ã‘ã®å…¬å¼ã‚¬ã‚¤ãƒ‰ãƒ©ã‚¤ãƒ³ã‚’ç­–å®šã™ã‚‹ã€‚
  * éƒ¨ç½²æ¨ªæ–­ã®ã€ŒAIæ´»ç”¨æ¨é€²å§”å“¡ä¼šã€ã‚’ç«‹ã¡ä¸Šã’ã€æˆåŠŸäº‹ä¾‹ã®å…±æœ‰ã¨ãƒ«ãƒ¼ãƒ«ã®å®šæœŸè¦‹ç›´ã—ãƒ—ãƒ­ã‚»ã‚¹ã‚’åˆ¶åº¦åŒ–ã™ã‚‹ã€‚
* **æœŸå¾…åŠ¹æœï¼š** 1å¹´å¾Œã«ã¯ã€AIæ´»ç”¨ãŒç‰¹åˆ¥ãªã“ã¨ã§ã¯ãªãã€æ¥­å‹™ã®å½“ãŸã‚Šå‰ã®ã‚¤ãƒ³ãƒ•ãƒ©ã¨ã—ã¦å®šç€ã—ã¾ã™ã€‚

---

## ğŸ’¡ å°‚é–€å®¶ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
ã‚ãªãŸã®çµ„ç¹”ã®ã€Œæ…é‡ã•ã€ã¯ã€å®Ÿã¯å¤§ããªæ­¦å™¨ã§ã™ã€‚ãƒªã‚¹ã‚¯ã‚’æ­£ã—ãæã‚Œã‚‹ã“ã¨ãŒã§ãã‚‹çµ„ç¹”ã“ãã€ä¸€åº¦ãƒ«ãƒ¼ãƒ«ãŒæ±ºã¾ã‚Œã°æœ€ã‚‚å¼·å›ºãªã‚·ã‚¹ãƒ†ãƒ ã‚’ä½œã‚Šä¸Šã’ã‚‹ã“ã¨ãŒã§ãã¾ã™ã€‚ã¾ãšã¯ã€Œå®Œç’§ãªæ­£è§£ã€ã‚’æ±‚ã‚ã‚‹ã®ã‚’ã‚„ã‚ã€å°ã•ãªå®Ÿé¨“ã‹ã‚‰å§‹ã‚ã¦ã¿ã¾ã—ã‚‡ã†ã€‚ã€Œå®‰å…¨ãªéŠã³å ´ã€ã•ãˆä½œã‚Œã°ã€ç¾å ´ã®ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã¯ä¸€æ°—ã«é–‹èŠ±ã™ã‚‹ã¯ãšã§ã™ã€‚`;
      } else {
        // ãã®ä»–ã®è»¸ç”¨ï¼ˆæ±ç”¨ãƒ†ãƒ³ãƒ—ãƒ¬ãƒ¼ãƒˆï¼‰
        analysisText = `# ğŸ¯ è¨ºæ–­çµæœãƒ¬ãƒãƒ¼ãƒˆ

---

## ğŸš© æœ€å¤§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯
### **ã€${axisLabels[bottleneckAxis]}ã€‘**
> ã“ã“ãŒã€ã‚ãªãŸã®çµ„ç¹”ãŒã€ŒAIå…±åƒå‹ã€ã¸é€²åŒ–ã™ã‚‹ã®ã‚’å¦¨ã’ã¦ã„ã‚‹æœ€å¤§ã®å£ã§ã™ã€‚

---

## ğŸ” ç¾çŠ¶ã®åˆ†æï¼šãƒªãƒ‡ã‚¶ã‚¤ãƒ³ãƒ¬ãƒ™ãƒ«
| ç¾åœ¨ã®æ¨å®šãƒ¬ãƒ™ãƒ« | ç›®æŒ‡ã™ã¹ãå§¿ |
| :--- | :--- |
| **ãƒ¬ãƒ™ãƒ« 2ï¼ˆä¸€éƒ¨è‡ªå‹•åŒ–ï¼‰** | **ãƒ¬ãƒ™ãƒ« 3ï¼ˆæ¥­å‹™å…¨ä½“ã®å†è¨­è¨ˆï¼‰** |

### âš¡ è§£æ±ºã™ã¹ãã€Œ2é‡ã®å£ã€
ã“ã®è»¸ã®ã‚¹ã‚³ã‚¢ã®ä½ã•ã¯ã€çµ„ç¹”å…¨ä½“ã®å¤‰é©ã‚¹ãƒ”ãƒ¼ãƒ‰ã‚’è½ã¨ã—ã¦ã„ã‚‹ä¸»è¦å› ã§ã™ã€‚

${lowestQuestions.split(',').map(q => `* **èª²é¡Œï¼š** ${q.trim()} ã®ã‚¹ã‚³ã‚¢ãŒä½ãã€ç¾å ´ã§ã®ãƒœãƒˆãƒ«ãƒãƒƒã‚¯ã«ãªã£ã¦ã„ã¾ã™ã€‚`).join('\n')}

---

## ğŸ› ï¸ æ”¹å–„ãƒ­ãƒ¼ãƒ‰ãƒãƒƒãƒ—

### ğŸ¾ Step 1ï¼šçŸ­æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆä»Šã™ãå®Ÿè¡Œï¼‰
* **å†…å®¹ï¼š** ä½ã‚¹ã‚³ã‚¢è¨­å•ã«å¯¾ã™ã‚‹å±€æ‰€çš„ãªæ”¹å–„æ–½ç­–ã®å®Ÿè¡Œ
* **ç†ç”±ï¼š** å°ã•ãªæˆåŠŸä½“é¨“ã‚’ä½œã‚Šã€å¤‰åŒ–ã¸ã®å¿ƒç†çš„ãƒãƒ¼ãƒ‰ãƒ«ã‚’ä¸‹ã’ã‚‹ãŸã‚ã€‚
* **æœŸå¾…åŠ¹æœï¼š** ç¾å ´ã®è² æ‹…æ„ŸãŒè»½æ¸›ã•ã‚Œã€å‰å‘ããªç©ºæ°—ãŒç”Ÿã¾ã‚Œã¾ã™ã€‚

### ğŸš€ Step 2ï¼šä¸­é•·æœŸã‚¢ã‚¯ã‚·ãƒ§ãƒ³ï¼ˆç†æƒ³ã®å§¿ã¸ï¼‰
* **å†…å®¹ï¼š** çµ„ç¹”å…¨ä½“ã§ã®å­¦ç¿’ãƒ—ãƒ­ã‚»ã‚¹ã®ç¢ºç«‹
* **ç†ç”±ï¼š** å€‹äººã®ã‚¹ã‚­ãƒ«ã‚¢ãƒƒãƒ—ã ã‘ã§ãªãã€çµ„ç¹”ã¨ã—ã¦ã®å­¦ç¿’èƒ½åŠ›ã‚’é«˜ã‚ã‚‹ãŸã‚ã€‚
* **æœŸå¾…åŠ¹æœï¼š** è‡ªå¾‹çš„ã«æ”¹å–„ã‚µã‚¤ã‚¯ãƒ«ãŒå›ã‚‹çµ„ç¹”ã¸ã¨é€²åŒ–ã—ã¾ã™ã€‚

---

## ğŸ’¡ å°‚é–€å®¶ã‹ã‚‰ã®ã‚¢ãƒ‰ãƒã‚¤ã‚¹
**${axisLabels[bottleneckAxis]}** ã®èª²é¡Œã¯ã€è£ã‚’è¿”ã›ã°æœ€å¤§ã®ä¼¸ã³ã—ã‚ã§ã™ã€‚ä»Šã¯åœæ»ã—ã¦ã„ã‚‹ã‚ˆã†ã«æ„Ÿã˜ã‚‹ã‹ã‚‚ã—ã‚Œã¾ã›ã‚“ãŒã€ã“ã®å£ã•ãˆçªç ´ã§ãã‚Œã°ã€ä»–ã®é ˜åŸŸã‚‚é€£å‹•ã—ã¦åŠ‡çš„ã«æ”¹å–„ã™ã‚‹ãƒãƒ†ãƒ³ã‚·ãƒ£ãƒ«ã‚’ç§˜ã‚ã¦ã„ã¾ã™ã€‚`;
      }

      resolve({
        success: true,
        analysis: analysisText
      });
    }, 1500);
  });
}

/**
 * APIéšœå®³æ™‚ã®ãƒ€ãƒŸãƒ¼åˆ†æï¼ˆãƒ•ã‚©ãƒ¼ãƒ«ãƒãƒƒã‚¯ç”¨ï¼‰
 */
function getDummyAnalysis(scores: Scores): string {
  return `
ã€è¨ºæ–­çµæœã‚µãƒãƒªãƒ¼ã€‘
å„è»¸ã®ã‚¹ã‚³ã‚¢ã¯ä»¥ä¸‹ã®é€šã‚Šã§ã™ï¼š
- è‡ªåˆ†ï¼ˆå†…å´ï¼‰: ${scores.human_internal}
- è³‡æºï¼ˆå†…å´ï¼‰: ${scores.resource_internal}
- ä»–è€…ï¼ˆå¤–å´ï¼‰: ${scores.human_external}
- ç’°å¢ƒï¼ˆå¤–å´ï¼‰: ${scores.environment_external}

â€»ç¾åœ¨ã€AIåˆ†ææ©Ÿèƒ½ã¯ä¸€æ™‚çš„ã«åˆ©ç”¨ã§ãã¾ã›ã‚“ã€‚å¾Œã»ã©ãŠè©¦ã—ãã ã•ã„ã€‚
  `.trim();
}

/**
 * Difyã‹ã‚‰ã®ãƒ¬ã‚¹ãƒãƒ³ã‚¹ã‚’ã‚¯ãƒªãƒ¼ãƒ‹ãƒ³ã‚°ã™ã‚‹
 * (è‹±èªã®æ€è€ƒãƒ—ãƒ­ã‚»ã‚¹ã‚„ãƒ—ãƒªã‚¢ãƒ³ãƒ–ãƒ«ã‚’é™¤å»ã—ã€Markdownéƒ¨åˆ†ã®ã¿ã‚’æŠ½å‡º)
 */
function cleanDifyResponse(text: string): string {
  if (!text) return '';

  let cleaned = text;

  // 1. å…ˆé ­ã®ä¸ç´”ç‰©ï¼ˆThinkingãƒ—ãƒ­ã‚»ã‚¹ã‚„ã€"Here is the report:" ãªã©ã®å‰ç½®ãï¼‰ã‚’é™¤å»
  // # ã¾ãŸã¯ ## ã§å§‹ã¾ã‚‹æœ€åˆã®è¡Œã‚’æ¢ã™
  const firstHeaderIndex = cleaned.search(/^#+\s/m);
  if (firstHeaderIndex !== -1) {
    cleaned = cleaned.substring(firstHeaderIndex);
  }

  // 2. æœ«å°¾ã®ä¸ç´”ç‰©ï¼ˆé–‰ã˜ã‚³ãƒ¼ãƒ‰ãƒ–ãƒ­ãƒƒã‚¯è¨˜å· ``` ãªã©ï¼‰ã‚’é™¤å»
  cleaned = cleaned.replace(/```\s*$/g, '');

  return cleaned.trim();
}

